<!DOCTYPE html>
<meta charset="utf-8">
<style>

.county {
  stroke: #fff;
  stroke-width: .5px;
}

.hover {
  fill: red;
  opacity: .5;

}
    .hidden {
        display: none;
    }
    div.tooltip {
        color: #222;
        background-color: #fff;
        padding: .5em;
        text-shadow: #f5f5f5 0 1px 0;
        border-radius: 2px;
        opacity: 0.9;
        position: absolute;
    }
}

</style>
<body>
<script src="//d3js.org/d3.v3.min.js"></script>
<script src="//d3js.org/topojson.v1.min.js"></script>
<script src="//d3js.org/queue.v1.min.js"></script>
<script>

var width = 960;
    height = 500;
    legendRectSize = 18;
    legendSpacing = 4;

var tooltip = d3.select('body').append('div')
    .attr('class', 'hidden tooltip');

var oStat = d3.map();

var path = d3.geo.path();

var svg = d3.select("body").append("svg")
    .attr("width", width)
    .attr("height", height);

    var projection = d3.geo.albers()
      .translate([width / 2, height / 2])
      .scale(4500)
      .rotate([93.25, 0])
      .center([0, 46.5]);

var lookup = {"DFANP":"Open - No Policy", "DFAP":"Open - Policy", "PUC":"Policy Under Consideration", "SL":"Not Open or Unknown","PD":"Public Domain"}


var color = d3.scale.ordinal()
    .domain(["PD","DFANP","DFAP","PUC","SL"])
    .range(["#cc3300","#99d58c","#14613f","#95afec","#f4b77a"]);

    var legend = d3.select('svg')
        .append("g")
        .selectAll("g")
        .data(color.domain())
        .enter()
        .append('g')
          .attr('class', 'legend')
          .attr('transform', function(d, i) {
            var height = legendRectSize;
            var x = 0;
            var y = i * height;
            return 'translate(' + x + ',' + y + ')';
        });

var geoPath = d3.geo.path()
          .projection(projection);

          legend.append('rect')
              .attr('width', legendRectSize)
              .attr('height', legendRectSize)
              .style('fill', color)
              .style('stroke', color);

          legend.append('text')
              .attr('x', legendRectSize + legendSpacing)
              .attr('y', legendRectSize - legendSpacing)
              .text(function(d) { return lookup[d]; });


queue()
    .defer(d3.json, "mnocounties.json")
    //.defer(d3.csv,"openstatus.csv", function(d) { oStat.set(d.id, d.openstatus); })
    .defer(d3.csv,"openstatus.csv", function(d) { oStat.set(d.id, [d.openstatus,d.openyear,d.plcyyear]); })
    .await(ready);

function ready (error, mnocounties) {
  if (error) throw error;
  svg.selectAll("path")
      .data(topojson.feature(mnocounties, mnocounties.objects.mncounties_4326).features)
    .enter().append("path")
    .attr("class","county")
      .style("fill", function(d) { return color(oStat.get(d.id)[0]); })
      .attr("d", geoPath) //;

      .on('mousemove', function(d) {
                    var mouse = d3.mouse(svg.node()).map(function(d) {
                        return parseInt(d);
                    });
        tooltip.classed('hidden', false)
                          .attr('style', 'left:' + (mouse[0] + 15) +
                                  'px; top:' + (mouse[1] - 35) + 'px')
                                  .html(d.properties.name + "<br>" + lookup[oStat.get(d.id)[0]]+ "<br>"  + (oStat.get(d.id)[1] != "" ? "Opened in " + oStat.get(d.id)[1] + "<br />": "" ) + (oStat.get(d.id)[2] != "" ? "Policy in " + oStat.get(d.id)[2]: "" ));

      d3.select(this).attr("class","hover");})
      .on ("mouseout", function(d) {


      tooltip.classed('hidden', true);
      d3.select(this).attr("class","county");})
};

</script>
